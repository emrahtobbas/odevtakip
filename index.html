<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ödev Takip Sistemi — Demo (GitHub Pages)</title>
  <link rel="icon" href="assets/logo.svg">
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --primary:#2563eb; --primary-weak:#eff6ff; --line:#e5e7eb; --good:#16a34a; --bad:#dc2626; --warn:#d97706;
      --card:#ffffff; --shadow:0 6px 24px rgba(2,6,23,.05),0 2px 8px rgba(2,6,23,.04);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit}
    header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);z-index:10}
    header .top{background-image:url('assets/header-bg.jpg'); background-size:cover; background-position:center;}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff url('assets/logo.svg') center/70% no-repeat;box-shadow:var(--shadow)}
    h1{margin:0;font-size:28px;color:#0f172a;text-shadow:0 1px 0 rgba(255,255,255,.5)}
    .pill{padding:6px 12px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff}

    .decor-left, .decor-right{position:fixed; top:90px; bottom:90px; width:120px; pointer-events:none; opacity:.12; background-size:contain; background-repeat:no-repeat; background-position:center}
    .decor-left{left:0; background-image:url('assets/side-left.png');}
    .decor-right{right:0; background-image:url('assets/side-right.png');}

    .grid{display:grid;gap:18px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h3{margin:4px 0 12px;font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center}
    .row>*{flex:1}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn.ghost{background:#fff}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .hidden{display:none !important}

    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);margin-bottom:12px}
    .tab{padding:10px 12px;border:1px solid var(--line);border-bottom:none;border-radius:12px 12px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:var(--primary-weak);color:var(--primary);font-weight:600}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    tr:hover td{background:#fafafa}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .badge.good{color:var(--good);border-color:#bbf7d0;background:#f0fdf4}
    .badge.warn{color:var(--warn);border-color:#fde68a;background:#fffbeb}
    .badge.bad{color:var(--bad);border-color:#fecaca;background:#fef2f2}

    .section{margin:16px 0;padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fff}
    footer{border-top:1px solid var(--line);background:#fff url('assets/footer-texture.png') center/cover no-repeat;}
  </style>
</head>
<body>
  <div class="decor-left" aria-hidden="true"></div>
  <div class="decor-right" aria-hidden="true"></div>

  <header>
    <div class="top">
      <div class="container" style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;padding-bottom:12px">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Ödev Takip Sistemi (Demo)</h1>
            <div class="muted" style="font-size:13px">GitHub Pages için tek dosya HTML · localStorage</div>
          </div>
        </div>
        <div id="activeUser" class="pill">Giriş yapılmadı</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- AUTH -->
    <section id="authView">
      <p class="muted">Bu demo, verileri cihazda <b>localStorage</b>’da tutar. <b>Demo Verileri Yükle</b> ile hızlıca deneyebilirsiniz.</p>
      <div class="grid">
        <div class="card">
          <h3>Öğretmen Girişi</h3>
          <label>Öğretmen Adı</label>
          <input id="t-name" placeholder="örn. ogretmen" />
          <label style="margin-top:8px">Şifre/PIN</label>
          <input id="t-pass" type="password" placeholder="örn. 1234" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="loginTeacher()">Giriş Yap</button>
            <button class="btn ghost" onclick="seedDemo()">Demo Verileri Yükle</button>
          </div>
          <p class="muted" style="font-size:12px;margin-top:8px">Demo: ad <b>ogretmen</b>, şifre <b>1234</b></p>
        </div>
        <div class="card">
          <h3>Öğrenci Girişi</h3>
          <label>Öğrenci Adı</label>
          <input id="s-name" placeholder="örn. Ayşe Y." />
          <label style="margin-top:8px">Öğrenci Kodu</label>
          <input id="s-code" placeholder="örn. STU-1234" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="loginStudent()">Giriş Yap</button>
          </div>
        </div>
        <div class="card">
          <h3>Veli Girişi</h3>
          <label>Veli Adı</label>
          <input id="p-name" placeholder="örn. Mehmet B." />
          <label style="margin-top:8px">Veli Kodu</label>
          <input id="p-code" placeholder="örn. PAR-1234" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="loginParent()">Giriş Yap</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="toolbar">
          <button class="btn" onclick="exportData()">Verileri Dışa Aktar (JSON)</button>
          <label class="btn" for="importFile" style="cursor:pointer">Verileri İçe Aktar</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <button class="btn" onclick="resetAll()">Sistemi Sıfırla</button>
        </div>
      </div>
    </section>

    <!-- TEACHER DASHBOARD -->
    <section id="teacherView" class="hidden">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="students" onclick="switchTab(this)">Öğrenciler</div>
        <div class="tab" data-tab="parents" onclick="switchTab(this)">Veliler</div>
        <div class="tab" data-tab="assignments" onclick="switchTab(this)">Ödevler</div>
      </div>

      <div class="tabpanel" id="tab-students">
        <div class="card" style="margin-bottom:12px">
          <h3>Öğrenci Ekle</h3>
          <div class="row">
            <div>
              <label>Ad Soyad</label>
              <input id="st-name" />
            </div>
            <div>
              <label>Sınıf</label>
              <input id="st-class" placeholder="örn. 7/A" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Veli Adı (opsiyonel)</label>
              <input id="st-parent-name" placeholder="örn. Ayşe K." />
            </div>
            <div>
              <label>Veli İletişim (opsiyonel)</label>
              <input id="st-parent-contact" placeholder="e-posta/telefon" />
            </div>
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="addStudent()">Ekle</button>
          </div>
        </div>
        <div class="card">
          <h3>Öğrenci Listesi</h3>
          <table id="studentsTable">
            <thead>
              <tr><th>Ad Soyad</th><th>Sınıf</th><th>Öğrenci Kodu</th><th>Veli</th><th>Veli Kodu</th><th>Aksiyon</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="tabpanel hidden" id="tab-parents">
        <div class="card" style="margin-bottom:12px">
          <h3>Veli Ekle</h3>
          <div class="row">
            <div>
              <label>Veli Adı</label>
              <input id="pa-name" />
            </div>
            <div>
              <label>İletişim</label>
              <input id="pa-contact" placeholder="e-posta/telefon" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Öğrenci</label>
              <select id="pa-student"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn primary" onclick="addParent()">Ekle</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Veli Listesi</h3>
          <table id="parentsTable">
            <thead>
              <tr><th>Veli</th><th>Çocuk</th><th>Veli Kodu</th><th>İletişim</th><th>Aksiyon</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="tabpanel hidden" id="tab-assignments">
        <div class="card" style="margin-bottom:12px">
          <h3>Ödev Oluştur</h3>
          <div class="row">
            <div>
              <label>Başlık</label>
              <input id="as-title" placeholder="örn. Kesirler Çalışma Kağıdı" />
            </div>
            <div>
              <label>Teslim Tarihi</label>
              <input id="as-due" type="date" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Hedef (Sınıf veya Öğrenciler)</label>
              <input id="as-target" placeholder="örn. 7/A veya Ayşe; Ali" />
            </div>
            <div>
              <label>Ders</label>
              <input id="as-subject" placeholder="örn. Matematik" />
            </div>
          </div>
          <label style="margin-top:8px">Açıklama / Bağlantı</label>
          <textarea id="as-desc" placeholder="Detaylar, link, yönergeler..."></textarea>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="addAssignment()">Kaydet</button>
          </div>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>Ödevler</h3>
            <div class="row" style="max-width:420px">
              <input id="as-filter" placeholder="Başlık/öğrenci/sınıf ara" oninput="renderAssignments()" />
              <select id="as-status" onchange="renderAssignments()">
                <option value="all">Tümü</option>
                <option value="open">Açık</option>
                <option value="past">Süresi Geçen</option>
                <option value="archived">Arşiv</option>
              </select>
            </div>
          </div>
          <table id="assignmentsTable">
            <thead>
              <tr><th>Başlık</th><th>Ders</th><th>Hedef</th><th>Teslim</th><th>Durum</th><th>Aksiyon</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- STUDENT DASHBOARD -->
    <section id="studentView" class="hidden">
      <div class="card">
        <h3>Ödevlerim</h3>
        <div class="row" style="margin-bottom:10px">
          <input id="st-search" placeholder="başlık/ders ara" oninput="renderStudentAssignments()" />
          <select id="st-sort" onchange="renderStudentAssignments()">
            <option value="due">Tarihe göre</option>
            <option value="title">Başlığa göre</option>
          </select>
        </div>
        <table id="studentAsTable">
          <thead>
            <tr><th>Başlık</th><th>Ders</th><th>Teslim</th><th>Durum</th><th>Aksiyon</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PARENT DASHBOARD -->
    <section id="parentView" class="hidden">
      <div class="card">
        <h3>Çocuğumun Ödevleri</h3>
        <div class="row" style="margin-bottom:10px">
          <select id="pa-child" onchange="renderParentAssignments()"></select>
          <input id="pa-search" placeholder="başlık/ders ara" oninput="renderParentAssignments()" />
        </div>
        <table id="parentAsTable">
          <thead>
            <tr><th>Başlık</th><th>Ders</th><th>Teslim</th><th>Durum</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;gap:12px;flex-wrap:wrap">
      <div class="muted" style="font-size:13px">Yerel veri: <span id="stats"></span></div>
      <div class="toolbar">
        <button class="btn" onclick="logout()">Çıkış</button>
      </div>
    </div>
  </footer>

  <script>
    /********************
     * Basit Depo (localStorage)
     ********************/
    const DB_KEY = 'odevTakipDB_v1';
    function loadDB(){
      const raw = localStorage.getItem(DB_KEY);
      if(!raw){
        const empty = {teachers:[], students:[], parents:[], assignments:[], done:[]};
        localStorage.setItem(DB_KEY, JSON.stringify(empty));
        return empty;
      }
      try{ return JSON.parse(raw); }catch(e){ return {teachers:[], students:[], parents:[], assignments:[], done:[]}; }
    }
    function saveDB(db){ localStorage.setItem(DB_KEY, JSON.stringify(db)); refreshStats(); }
    function refreshStats(){
      const db = loadDB();
      document.getElementById('stats').textContent = `Öğrt:${db.teachers.length} • Öğr:${db.students.length} • Veli:${db.parents.length} • Ödev:${db.assignments.length}`;
    }

    /********************
     * Yardımcılar
     ********************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const uid = (p) => `${p}-${Math.random().toString(36).slice(2,8).toUpperCase()}`;
    const todayStr = () => new Date().toISOString().slice(0,10);
    const fmtDate = (d) => new Date(d+'T00:00:00').toLocaleDateString('tr-TR', {weekday:'short',day:'2-digit',month:'2-digit'});

    function toast(msg){ alert(msg); }

    /********************
     * Oturum
     ********************/
    let session = {role:null, user:null};
    function setActiveUser(){
      const el = document.getElementById('activeUser');
      if(!session.role){ el.textContent = 'Giriş yapılmadı'; return; }
      el.textContent = `${session.role.toUpperCase()} · ${session.user?.name || ''}`;
    }
    function hideAll(){
      ['authView','teacherView','studentView','parentView'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    }
    function show(id){ document.getElementById(id).classList.remove('hidden'); }
    function logout(){
      session = {role:null,user:null};
      setActiveUser();
      hideAll(); show('authView');
    }

    /********************
     * Giriş İşlemleri
     ********************/
    function loginTeacher(){
      const name = document.getElementById('t-name').value.trim();
      const pass = document.getElementById('t-pass').value.trim();
      const db = loadDB();
      const t = db.teachers.find(x=>x.name.toLowerCase()===name.toLowerCase() && x.password===pass);
      if(!t){ toast('Öğretmen bulunamadı. Demo: ogretmen / 1234'); return; }
      session={role:'öğretmen', user:t};
      setActiveUser();
      hideAll(); show('teacherView');
      renderStudents(); renderParents(); renderAssignments();
      fillParentStudentSelect();
    }

    function loginStudent(){
      const name = document.getElementById('s-name').value.trim();
      const code = document.getElementById('s-code').value.trim();
      const db = loadDB();
      const s = db.students.find(x=>x.name.toLowerCase()===name.toLowerCase() && x.code===code);
      if(!s){ toast('Öğrenci bulunamadı. (Kod örn: STU-AB12CD)'); return; }
      session={role:'öğrenci', user:s};
      setActiveUser();
      hideAll(); show('studentView');
      renderStudentAssignments();
    }

    function loginParent(){
      const name = document.getElementById('p-name').value.trim();
      const code = document.getElementById('p-code').value.trim();
      const db = loadDB();
      const p = db.parents.find(x=>x.name.toLowerCase()===name.toLowerCase() && x.code===code);
      if(!p){ toast('Veli bulunamadı. (Kod örn: PAR-1A2B3C)'); return; }
      session={role:'veli', user:p};
      setActiveUser();
      hideAll(); show('parentView');
      fillParentChildren();
      renderParentAssignments();
    }

    /********************
     * Demo Verileri
     ********************/
    function seedDemo(){
      const db = loadDB();
      if(db.students.length||db.teachers.length||db.parents.length||db.assignments.length){
        if(!confirm('Mevcut verileriniz üzerine demo verileri eklenecek. Devam edilsin mi?')) return;
      }
      const t = {id:uid('TCH'), name:'ogretmen', password:'1234'};
      const s1 = {id:uid('STU'), name:'Ayşe Yılmaz', class:'7/A', code:uid('STU')};
      const s2 = {id:uid('STU'), name:'Ali Demir', class:'7/A', code:uid('STU')};
      const p1 = {id:uid('PAR'), name:'Mehmet Yılmaz', contact:'mehmet@example.com', code:uid('PAR'), students:[s1.id]};
      const p2 = {id:uid('PAR'), name:'Elif Demir', contact:'0532 000 00 00', code:uid('PAR'), students:[s2.id]};
      const as1 = {id:uid('ASG'), title:'Kesirler Alıştırma', subject:'Matematik', desc:'Kitap s.34-36, 1-8 arası sorular', due:todayStr(), targets:['7/A'], archived:false};
      const as2 = {id:uid('ASG'), title:'Okuma Ödevi', subject:'Türkçe', desc:'“Mavi Yolculuk” metni', due:todayStr(), targets:[s1.id], archived:false};
      db.teachers.push(t);
      db.students.push(s1,s2);
      db.parents.push(p1,p2);
      db.assignments.push(as1,as2);
      saveDB(db);
      refreshStats();
      toast('Demo eklendi. Öğretmen: ogretmen / 1234');
    }

    /********************
     * Öğrenciler
     ********************/
    function addStudent(){
      const name=$('#st-name').value.trim();
      const clazz=$('#st-class').value.trim();
      const pName=$('#st-parent-name').value.trim();
      const pContact=$('#st-parent-contact').value.trim();
      if(!name||!clazz){ toast('Ad ve sınıf zorunlu.'); return; }
      const db = loadDB();
      const s = {id:uid('STU'), name, class:clazz, code:uid('STU')};
      db.students.push(s);
      if(pName){
        const parent={id:uid('PAR'), name:pName, contact:pContact||'', code:uid('PAR'), students:[s.id]};
        db.parents.push(parent);
      }
      saveDB(db);
      $('#st-name').value=''; $('#st-class').value=''; $('#st-parent-name').value=''; $('#st-parent-contact').value='';
      renderStudents(); renderParents(); fillParentStudentSelect();
    }

    function deleteStudent(id){
      const db=loadDB();
      db.students = db.students.filter(x=>x.id!==id);
      db.parents.forEach(p=>p.students=p.students.filter(sid=>sid!==id));
      saveDB(db); renderStudents(); renderParents(); fillParentStudentSelect();
    }

    function renderStudents(){
      const db=loadDB();
      const tbody = $('#studentsTable tbody');
      tbody.innerHTML = db.students.map(s=>{
        const parent = db.parents.find(p=>p.students.includes(s.id));
        return `<tr>
          <td>${s.name}</td>
          <td>${s.class}</td>
          <td><span class="badge">${s.code}</span></td>
          <td>${parent?parent.name:'—'}</td>
          <td>${parent?`<span class='badge'>${parent.code}</span>`:'—'}</td>
          <td><button class="btn" onclick="copyText('${s.code}')">Kodu Kopyala</button> <button class="btn" onclick="deleteStudent('${s.id}')">Sil</button></td>
        </tr>`;
      }).join('');
    }

    function fillParentStudentSelect(){
      const db=loadDB();
      const sel = $('#pa-student');
      sel.innerHTML = db.students.map(s=>`<option value="${s.id}">${s.name} · ${s.class}</option>`).join('');
    }

    /********************
     * Veliler
     ********************/
    function addParent(){
      const name=$('#pa-name').value.trim();
      const contact=$('#pa-contact').value.trim();
      const studentId=$('#pa-student').value;
      if(!name||!studentId){ toast('Veli adı ve öğrenci gerekli.'); return; }
      const db=loadDB();
      const p={id:uid('PAR'), name, contact, code:uid('PAR'), students:[studentId]};
      db.parents.push(p);
      saveDB(db);
      $('#pa-name').value=''; $('#pa-contact').value='';
      renderParents();
    }

    function deleteParent(id){
      const db=loadDB();
      db.parents = db.parents.filter(x=>x.id!==id);
      saveDB(db); renderParents();
    }

    function renderParents(){
      const db=loadDB();
      const tbody=$('#parentsTable tbody');
      tbody.innerHTML = db.parents.map(p=>{
        const kids = p.students.map(id=>db.students.find(s=>s.id===id)?.name||'—').join(', ');
        return `<tr>
          <td>${p.name}</td>
          <td>${kids||'—'}</td>
          <td><span class="badge">${p.code}</span></td>
          <td>${p.contact||'—'}</td>
          <td><button class="btn" onclick="copyText('${p.code}')">Kodu Kopyala</button> <button class="btn" onclick="deleteParent('${p.id}')">Sil</button></td>
        </tr>`;
      }).join('');
    }

    function fillParentChildren(){
      const db=loadDB();
      const sel=$('#pa-child');
      const p=session.user;
      sel.innerHTML=(p.students||[]).map(id=>{
        const s=db.students.find(x=>x.id===id);
        return `<option value="${id}">${s?.name||'—'} · ${s?.class||''}</option>`;
      }).join('');
    }

    /********************
     * Ödevler
     ********************/
    function addAssignment(){
      const title=$('#as-title').value.trim();
      const due=$('#as-due').value || todayStr();
      const target=$('#as-target').value.trim();
      const subject=$('#as-subject').value.trim();
      const desc=$('#as-desc').value.trim();
      if(!title||!target){ toast('Başlık ve hedef gerekli.'); return; }
      const targets = target.split(';').map(s=>s.trim()).filter(Boolean);
      const db=loadDB();
      db.assignments.push({id:uid('ASG'), title, due, subject, desc, targets, archived:false});
      saveDB(db);
      $('#as-title').value=''; $('#as-due').value=''; $('#as-target').value=''; $('#as-subject').value=''; $('#as-desc').value='';
      renderAssignments();
      toast('Ödev eklendi.');
    }

    function archiveAssignment(id, val=true){
      const db=loadDB();
      const a=db.assignments.find(x=>x.id===id);
      if(a){ a.archived=val; saveDB(db); renderAssignments(); }
    }

    function deleteAssignment(id){
      const db=loadDB();
      db.assignments = db.assignments.filter(x=>x.id!==id);
      db.done = db.done.filter(d=>d.asg!==id);
      saveDB(db); renderAssignments(); renderStudentAssignments(); renderParentAssignments();
    }

    function matchesFilter(a, db){
      const q = $('#as-filter').value?.toLowerCase()||'';
      if(!q) return true;
      const inTargets = a.targets.join(' ').toLowerCase();
      const inNames = db.students.filter(s=>a.targets.includes(s.id)).map(s=>s.name.toLowerCase()).join(' ');
      return a.title.toLowerCase().includes(q) || (a.subject||'').toLowerCase().includes(q) || inTargets.includes(q) || inNames.includes(q);
    }

    function statusOf(a){
      const d = new Date(a.due+'T00:00:00');
      const today = new Date(todayStr()+'T00:00:00');
      if(a.archived) return {cls:'badge', text:'Arşiv'};
      if(d < today) return {cls:'badge bad', text:'Süresi geçti'};
      if(+d===+today) return {cls:'badge warn', text:'Bugün'};
      return {cls:'badge good', text:'Açık'};
    }

    function renderAssignments(){
      const db=loadDB();
      const tbody=$('#assignmentsTable tbody');
      const view = ($('#as-status').value||'all');
      tbody.innerHTML = db.assignments
        .filter(a=>matchesFilter(a,db))
        .filter(a=>{
          if(view==='all') return true;
          if(view==='archived') return a.archived;
          const s = statusOf(a).text;
          if(view==='open') return s==='Açık' || s==='Bugün';
          if(view==='past') return s==='Süresi geçti';
          return true;
        })
        .sort((a,b)=>a.due.localeCompare(b.due))
        .map(a=>{
          const s=statusOf(a);
          const targetLabel = a.targets.map(t=>/^STU-/.test(t)? (db.students.find(x=>x.id===t)?.name||'—') : t).join(', ');
          return `<tr>
            <td>${a.title}</td>
            <td>${a.subject||'—'}</td>
            <td>${targetLabel}</td>
            <td>${fmtDate(a.due)}</td>
            <td><span class="${s.cls}">${s.text}</span></td>
            <td>
              ${a.archived?`<button class='btn' onclick="archiveAssignment('${a.id}',false)">Geri Al</button>`:`<button class='btn' onclick="archiveAssignment('${a.id}',true)">Arşivle</button>`}
              <button class='btn' onclick="deleteAssignment('${a.id}')">Sil</button>
            </td>
          </tr>`;
        }).join('');
    }

    // Öğrenci tarafı
    function studentRelevant(a, student){
      return a.targets.includes(student.id) || a.targets.includes(student.class);
    }

    function isDone(asgId, stuId){
      const db=loadDB();
      return db.done.some(d=>d.asg===asgId && d.student===stuId);
    }

    function toggleDone(asgId, stuId){
      const db=loadDB();
      const i = db.done.findIndex(d=>d.asg===asgId && d.student===stuId);
      if(i>-1) db.done.splice(i,1); else db.done.push({asg:asgId, student:stuId, at:new Date().toISOString()});
      saveDB(db); renderStudentAssignments(); renderParentAssignments();
    }

    function renderStudentAssignments(){
      if(session.role!=="öğrenci") return;
      const db=loadDB(); const stu=session.user;
      const q = $('#st-search').value?.toLowerCase()||'';
      const sorter = $('#st-sort').value||'due';
      const items = db.assignments.filter(a=>!a.archived && studentRelevant(a,stu) && ((a.title.toLowerCase().includes(q)) || ((a.subject||'').toLowerCase().includes(q))));
      items.sort((a,b)=> sorter==='title'? a.title.localeCompare(b.title) : a.due.localeCompare(b.due));
      $('#studentAsTable tbody').innerHTML = items.map(a=>{
        const done = isDone(a.id, stu.id);
        const s = statusOf(a);
        return `<tr>
          <td>${a.title}</td>
          <td>${a.subject||'—'}</td>
          <td>${fmtDate(a.due)}</td>
          <td>${done?'<span class="badge good">Tamamlandı</span>':`<span class="${s.cls}">${s.text}</span>`}</td>
          <td><button class="btn" onclick="toggleDone('${a.id}','${stu.id}')">${done?'Geri Al':'Tamamla'}</button></td>
        </tr>`;
      }).join('');
    }

    // Veli tarafı
    function renderParentAssignments(){
      if(session.role!=="veli") return;
      const db=loadDB();
      const childId = $('#pa-child').value || session.user.students?.[0];
      const stu = db.students.find(s=>s.id===childId);
      const q = $('#pa-search').value?.toLowerCase()||'';
      const items = db.assignments.filter(a=>!a.archived && stu && studentRelevant(a,stu) && (a.title.toLowerCase().includes(q) || (a.subject||'').toLowerCase().includes(q)) )
        .sort((a,b)=>a.due.localeCompare(b.due));
      $('#parentAsTable tbody').innerHTML = items.map(a=>{
        const done = isDone(a.id, stu.id);
        return `<tr>
          <td>${a.title}</td>
          <td>${a.subject||'—'}</td>
          <td>${fmtDate(a.due)}</td>
          <td>${done?'<span class="badge good">Tamamlandı</span>':'<span class="badge warn">Bekliyor</span>'}</td>
        </tr>`;
      }).join('');
    }

    /********************
     * Sekmeler
     ********************/
    function switchTab(el){
      $$('.tab').forEach(t=>t.classList.remove('active'));
      el.classList.add('active');
      const k = el.dataset.tab;
      $$('.tabpanel').forEach(p=>p.classList.add('hidden'));
      document.getElementById('tab-'+k).classList.remove('hidden');
      if(k==='parents') fillParentStudentSelect();
      if(k==='assignments') renderAssignments();
    }

    /********************
     * İçe/Dışa Aktarma & Araçlar
     ********************/
    function exportData(){
      const data = JSON.stringify(loadDB(), null, 2);
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download='odev-takip-veri.json'; a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{ const json = JSON.parse(reader.result); localStorage.setItem(DB_KEY, JSON.stringify(json)); toast('Veriler içe aktarıldı.'); refreshStats(); }catch(err){ toast('Hatalı JSON.'); }
      };
      reader.readAsText(file);
    });

    function resetAll(){
      if(confirm('Tüm verileri silmek istediğinize emin misiniz?')){
        localStorage.removeItem(DB_KEY); loadDB(); refreshStats(); toast('Sistem sıfırlandı.');
      }
    }

    function copyText(text){
      navigator.clipboard?.writeText(text); toast('Kopyalandı');
    }

    refreshStats();
  </script>
</body>
</html>
