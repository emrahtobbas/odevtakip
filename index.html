<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ödev Takip Sistemi</title>
  <link rel="icon" href="/assets/logo.svg">
  <style>
    :root{
      --bg:#ffffff; --fg:#0f172a; --muted:#64748b; --primary:#2563eb; --primary-weak:#eff6ff; --line:#e5e7eb; --good:#16a34a; --bad:#dc2626; --warn:#d97706;
      --card:#ffffff; --shadow:0 6px 24px rgba(2,6,23,.05),0 2px 8px rgba(2,6,23,.04);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:inherit}

    /* Dekoratif görseller */
    .decor-left, .decor-right{position:fixed; top:90px; bottom:90px; width:120px; pointer-events:none; opacity:.12; background-size:contain; background-repeat:no-repeat; background-position:center}
    .decor-left{left:0; background-image:url('/assets/side-left.png');}
    .decor-right{right:0; background-image:url('/assets/side-right.png');}

    header{position:sticky;top:0;z-index:10;border-bottom:1px solid var(--line);background:var(--bg)}
    header .top{background-image:url('/assets/header-bg.jpg'); background-size:cover; background-position:center;}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:40px;height:40px;border-radius:10px;background:#fff url('/assets/logo.svg') center/70% no-repeat;box-shadow:var(--shadow)}
    h1{margin:0;font-size:28px;color:#0f172a;text-shadow:0 1px 0 rgba(255,255,255,.5)}
    .pill{padding:6px 12px;border:1px solid var(--line);border-radius:999px;color:var(--muted);background:#fff}

    footer{border-top:1px solid var(--line);background:#fff url('/assets/footer-texture.png') center/cover no-repeat;}

    .grid{display:grid;gap:18px}
    @media(min-width:720px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .card h3{margin:4px 0 12px;font-size:18px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:12px;align-items:center}
    .row>*{flex:1}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:transparent}
    .btn.ghost{background:#fff}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .hidden{display:none !important}

    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--line);margin-bottom:12px}
    .tab{padding:10px 12px;border:1px solid var(--line);border-bottom:none;border-radius:12px 12px 0 0;background:#fff;cursor:pointer}
    .tab.active{background:var(--primary-weak);color:var(--primary);font-weight:600}

    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
    th{color:var(--muted);font-weight:600}
    tr:hover td{background:#fafafa}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .badge.good{color:var(--good);border-color:#bbf7d0;background:#f0fdf4}
    .badge.warn{color:var(--warn);border-color:#fde68a;background:#fffbeb}
    .badge.bad{color:var(--bad);border-color:#fecaca;background:#fef2f2}

    .section{margin:16px 0;padding:12px;border:1px dashed var(--line);border-radius:12px;background:#fff}
  </style>
</head>
<body>
  <div class="decor-left" aria-hidden="true"></div>
  <div class="decor-right" aria-hidden="true"></div>

  <header>
    <div class="top">
      <div class="container" style="display:flex;justify-content:space-between;align-items:center;padding-top:12px;padding-bottom:12px">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>Ödev Takip Sistemi</h1>
            <div class="muted" style="font-size:13px">Sunucu destekli · JSON veritabanı</div>
          </div>
        </div>
        <div id="activeUser" class="pill">Giriş yapılmadı</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- AUTH -->
    <section id="authView">
      <p class="muted">Rolünü seç ve giriş yap. İlk kurulumda <b>“Demo Verileri Yükle”</b> ile öğretmen/öğrenci/veli/ödev eklenir.</p>
      <div class="grid">
        <div class="card">
          <h3>Öğretmen Girişi</h3>
          <label>Öğretmen Adı</label>
          <input id="t-name" placeholder="örn. acg" />
          <label style="margin-top:8px">Şifre/PIN</label>
          <input id="t-pass" type="password" placeholder="örn. 1234" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="loginTeacher()">Giriş Yap</button>
            <button class="btn ghost" onclick="seedDemo()">Demo Verileri Yükle</button>
          </div>
        </div>
        <div class="card">
          <h3>Öğrenci Girişi</h3>
          <label>Öğrenci Adı</label>
          <input id="s-name" placeholder="örn. Ayşe Y." />
          <label style="margin-top:8px">Öğrenci Kodu</label>
          <input id="s-code" placeholder="örn. STU-XXXXXX" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="loginStudent()">Giriş Yap</button>
          </div>
        </div>
        <div class="card">
          <h3>Veli Girişi</h3>
          <label>Veli Adı</label>
          <input id="p-name" placeholder="örn. Mehmet B." />
          <label style="margin-top:8px">Veli Kodu</label>
          <input id="p-code" placeholder="örn. PAR-XXXXXX" />
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="loginParent()">Giriş Yap</button>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="toolbar">
          <button class="btn" onclick="exportData()">Verileri Dışa Aktar (JSON)</button>
          <label class="btn" for="importFile" style="cursor:pointer">Verileri İçe Aktar</label>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
        </div>
      </div>
    </section>

    <!-- TEACHER DASHBOARD -->
    <section id="teacherView" class="hidden">
      <div class="tabs" role="tablist">
        <div class="tab active" data-tab="students" onclick="switchTab(this)">Öğrenciler</div>
        <div class="tab" data-tab="parents" onclick="switchTab(this)">Veliler</div>
        <div class="tab" data-tab="assignments" onclick="switchTab(this)">Ödevler</div>
      </div>

      <div class="tabpanel" id="tab-students">
        <div class="card" style="margin-bottom:12px">
          <h3>Öğrenci Ekle</h3>
          <div class="row">
            <div>
              <label>Ad Soyad</label>
              <input id="st-name" />
            </div>
            <div>
              <label>Sınıf</label>
              <input id="st-class" placeholder="örn. 7/A" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Veli Adı (opsiyonel)</label>
              <input id="st-parent-name" placeholder="örn. Ayşe K." />
            </div>
            <div>
              <label>Veli İletişim (opsiyonel)</label>
              <input id="st-parent-contact" placeholder="e-posta/telefon" />
            </div>
          </div>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="addStudent()">Ekle</button>
          </div>
        </div>
        <div class="card">
          <h3>Öğrenci Listesi</h3>
          <table id="studentsTable">
            <thead>
              <tr><th>Ad Soyad</th><th>Sınıf</th><th>Öğrenci Kodu</th><th>Veli</th><th>Veli Kodu</th><th>Aksiyon</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="tabpanel hidden" id="tab-parents">
        <div class="card" style="margin-bottom:12px">
          <h3>Veli Ekle</h3>
          <div class="row">
            <div>
              <label>Veli Adı</label>
              <input id="pa-name" />
            </div>
            <div>
              <label>İletişim</label>
              <input id="pa-contact" placeholder="e-posta/telefon" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Öğrenci</label>
              <select id="pa-student"></select>
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn primary" onclick="addParent()">Ekle</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Veli Listesi</h3>
          <table id="parentsTable">
            <thead>
              <tr><th>Veli</th><th>Çocuk</th><th>Veli Kodu</th><th>İletişim</th><th>Aksiyon</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="tabpanel hidden" id="tab-assignments">
        <div class="card" style="margin-bottom:12px">
          <h3>Ödev Oluştur</h3>
          <div class="row">
            <div>
              <label>Başlık</label>
              <input id="as-title" placeholder="örn. Kesirler Çalışma Kağıdı" />
            </div>
            <div>
              <label>Teslim Tarihi</label>
              <input id="as-due" type="date" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div>
              <label>Hedef Öğrenciler / Sınıflar</label>
              <select id="as-targets" multiple size="6" style="width:100%"></select>
              <small class="muted">Ctrl/Shift ile çoklu seçim. İlk grupta sınıflar, altında öğrenciler listelenir.</small>
            </div>
            <div>
              <label>Ders</label>
              <input id="as-subject" placeholder="örn. Matematik" />
            </div>
          </div>
          <label style="margin-top:8px">Açıklama / Bağlantı</label>
          <textarea id="as-desc" placeholder="Detaylar, link, yönergeler..."></textarea>
          <div class="toolbar" style="margin-top:12px">
            <button class="btn primary" onclick="addAssignment()">Kaydet</button>
          </div>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3>Ödevler</h3>
            <div class="row" style="max-width:420px">
              <input id="as-filter" placeholder="Başlık/öğrenci/sınıf ara" oninput="renderAssignments()" />
              <select id="as-status" onchange="renderAssignments()">
                <option value="all">Tümü</option>
                <option value="open">Açık</option>
                <option value="past">Süresi Geçen</option>
                <option value="archived">Arşiv</option>
              </select>
            </div>
          </div>
          <table id="assignmentsTable">
            <thead>
              <tr><th>Başlık</th><th>Ders</th><th>Hedef</th><th>Teslim</th><th>Durum</th><th>Aksiyon</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- STUDENT DASHBOARD -->
    <section id="studentView" class="hidden">
      <div class="card">
        <h3>Ödevlerim</h3>
        <div class="row" style="margin-bottom:10px">
          <input id="st-search" placeholder="başlık/ders ara" oninput="renderStudentAssignments()" />
          <select id="st-sort" onchange="renderStudentAssignments()">
            <option value="due">Tarihe göre</option>
            <option value="title">Başlığa göre</option>
          </select>
        </div>
        <table id="studentAsTable">
          <thead>
            <tr><th>Başlık</th><th>Açıklama</th><th>Ders</th><th>Teslim</th><th>Durum</th><th>Aksiyon</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- PARENT DASHBOARD -->
    <section id="parentView" class="hidden">
      <div class="card">
        <h3>Çocuğumun Ödevleri</h3>
        <div class="row" style="margin-bottom:10px">
          <select id="pa-child" onchange="renderParentAssignments()"></select>
          <input id="pa-search" placeholder="başlık/ders ara" oninput="renderParentAssignments()" />
        </div>
        <table id="parentAsTable">
          <thead>
            <tr><th>Başlık</th><th>Ders</th><th>Teslim</th><th>Durum</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer>
    <div class="container" style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;gap:12px;flex-wrap:wrap">
      <div class="muted" style="font-size:13px">Sunucu: <span id="stats">Hazır mı kontrol ediliyor…</span></div>
      <div class="toolbar">
        <button class="btn" onclick="logout()">Çıkış</button>
      </div>
    </div>
  </footer>

  <script>
    const api = {
      token:null, teacher:null, student:null, parent:null,
      headers(){ return this.token && this.teacher ? { 'x-auth-token': this.token, 'x-teacher-id': this.teacher.id, 'Content-Type':'application/json' } : { 'Content-Type':'application/json' }; },
      async get(url){ const r = await fetch(url, { headers: this.headers() }); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async post(url, body){ const r = await fetch(url, { method:'POST', headers: this.headers(), body: JSON.stringify(body||{}) }); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async del(url){ const r = await fetch(url, { method:'DELETE', headers: this.headers() }); if(!r.ok) throw new Error(await r.text()); return r.json(); },
      async patch(url, body){ const r = await fetch(url, { method:'PATCH', headers: this.headers(), body: JSON.stringify(body||{}) }); if(!r.ok) throw new Error(await r.text()); return r.json(); }
    };

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const fmtDate = (d) => new Date(d+'T00:00:00').toLocaleDateString('tr-TR', {weekday:'short',day:'2-digit',month:'2-digit'});

    const todayStr = () => new Date().toISOString().slice(0,10);
    function toast(msg){ alert(msg); }
    function setActiveUser(){
      const el = $('#activeUser');
      if(api.teacher) el.textContent = `ÖĞRETMEN · ${api.teacher.name}`;
      else if(api.student) el.textContent = `ÖĞRENCİ · ${api.student.name}`;
      else if(api.parent) el.textContent = `VELİ · ${api.parent.name}`;
      else el.textContent = 'Giriş yapılmadı';
    }
    function hideAll(){ ['authView','teacherView','studentView','parentView'].forEach(id=>$('#'+id).classList.add('hidden')); }
    function show(id){ $('#'+id).classList.remove('hidden'); }

    async function checkServer(){
      try{ const r = await api.get('/api/health'); $('#stats').textContent = r.ok ? 'Çalışıyor' : 'Hata'; }catch{ $('#stats').textContent = 'Erişim yok'; }
    }

    // AUTH
    async function seedDemo(){
      try{ const r = await api.post('/api/setup/seed-demo'); toast('Demo yüklendi. Öğretmen: ogretmen / 1234'); }
      catch(e){ toast('Demo yüklenemedi (muhtemelen daha önce kuruldu). İlk öğretmeni elle ekleyin: /api/setup/first-teacher'); }
    }
    async function loginTeacher(){
      const name = $('#t-name').value.trim(); const password = $('#t-pass').value.trim();
      try{ const r = await api.post('/api/login/teacher',{name,password}); api.teacher = r.teacher; api.token = r.token; setActiveUser(); hideAll(); show('teacherView'); renderStudents(); renderParents(); renderAssignments(); fillParentStudentSelect(); fillAssignmentTargetsSelect(); document.querySelector('#as-due').value = todayStr(); }
      catch(e){ toast('Giriş başarısız: ' + (e.message||'')); }
    }
    async function loginStudent(){
      const name = $('#s-name').value.trim(); const code = $('#s-code').value.trim();
      try{ const r = await api.post('/api/login/student',{name,code}); api.student = r.student; setActiveUser(); hideAll(); show('studentView'); renderStudentAssignments(); }
      catch(e){ toast('Giriş başarısız'); }
    }
    async function loginParent(){
      const name = $('#p-name').value.trim(); const code = $('#p-code').value.trim();
      try{ const r = await api.post('/api/login/parent',{name,code}); api.parent = r.parent; setActiveUser(); hideAll(); show('parentView'); fillParentChildren(); renderParentAssignments(); }
      catch(e){ toast('Giriş başarısız'); }
    }
    function logout(){ api.token=null; api.teacher=null; api.student=null; api.parent=null; setActiveUser(); hideAll(); show('authView'); }

    // TEACHER — Students
    async function renderStudents(){
      if(!api.teacher) return; const tbody = $('#studentsTable tbody');
      try{ const list = await api.get('/api/students'); const parents = await api.get('/api/parents');
        tbody.innerHTML = list.map(s=>{
          const par = parents.find(p => (p.students||[]).includes(s.id));
          return `<tr>
            <td>${a.title}</td>
            <td class="muted">${a.desc||'—'}</td>
            <td>${a.subject||'—'}</td>
            <td>${fmtDate(a.due)}</td>
            <td>${s}</td>
            <td><button class="btn" onclick="toggleDone('${a.id}')">${a.done?'Geri Al':'Tamamla'}</button></td>
          </tr>`;
      }).join('');
    }
    async function addAssignment(){
      const title=$('#as-title').value.trim();
      const due=($('#as-due').value||'').trim();
      const subject=$('#as-subject').value.trim();
      const desc=$('#as-desc').value.trim();
      const sel = document.querySelector('#as-targets');
      const targets = Array.from(sel?.selectedOptions||[]).map(o=>o.value);
      if(!title||targets.length===0){ toast('Başlık ve en az bir hedef gerekli'); return; }
      try{
        await api.post('/api/assignments',{ title, due: due||todayStr(), subject, desc, targets });
        $('#as-title').value=''; $('#as-due').value=todayStr(); $('#as-subject').value=''; $('#as-desc').value=''; if(sel) sel.selectedIndex=-1; renderAssignments(); toast('Ödev eklendi.');
      }catch(e){ toast('Kayıt başarısız'); }
    }); $('#as-title').value=''; $('#as-due').value=''; $('#as-target').value=''; $('#as-subject').value=''; $('#as-desc').value=''; renderAssignments(); toast('Ödev eklendi.'); }
      catch(e){ toast('Kayıt başarısız'); }
    }
    async function archiveAssignment(id, val){ try{ await api.patch('/api/assignments/'+id+'/archive',{ archived: !!val }); renderAssignments(); }catch(e){ toast('Arşivleme başarısız'); } }
    async function deleteAssignment(id){ if(!confirm('Silinsin mi?')) return; try{ await api.del('/api/assignments/'+id); renderAssignments(); }catch(e){ toast('Silme başarısız'); } }

    // STUDENT
    async function renderStudentAssignments(){
      if(!api.student) return; const tbody = $('#studentAsTable tbody');
      try{
        const list = await api.get('/api/assignments/for-student/'+api.student.id);
        const q = ($('#st-search').value||'').toLowerCase(); const sorter = ($('#st-sort').value||'due');
        const items = list.filter(a => a.title.toLowerCase().includes(q) || (a.subject||'').toLowerCase().includes(q));
        items.sort((a,b)=> sorter==='title'? a.title.localeCompare(b.title) : a.due.localeCompare(b.due));
        tbody.innerHTML = items.map(a=>{
          const s = a.done ? '<span class="badge good">Tamamlandı</span>' : (function(){
            const d = new Date(a.due+'T00:00:00'); const t = new Date(new Date().toISOString().slice(0,10)+'T00:00:00');
            if(d < t) return '<span class="badge bad">Süresi geçti</span>';
            if(+d===+t) return '<span class="badge warn">Bugün</span>';
            return '<span class="badge good">Açık</span>';
          })();
          return `<tr>
            <td title="${a.desc||''}">${a.title}</td>
            <td>${a.subject||'—'}</td>
            <td>${fmtDate(a.due)}</td>
            <td>${s}</td>
            <td><button class="btn" onclick="toggleDone('${a.id}')">${a.done?'Geri Al':'Tamamla'}</button></td>
          </tr>`;
        }).join('');
      }catch(e){ tbody.innerHTML = '<tr><td colspan="5">Veri alınamadı</td></tr>'; }
    }
    async function toggleDone(asgId){ try{ await api.post('/api/assignments/'+asgId+'/toggle-done', { studentId: api.student.id }); renderStudentAssignments(); }catch(e){ toast('İşaretleme başarısız'); } }

    // PARENT
    function fillParentChildren(){ if(!api.parent) return; api.get('/api/parents').then(()=>{}); /* öğretmen yetkisi gerektirmiyor, doğrudan parent verisini kullanıyoruz */
      // Parent login cevabında sadece ids var; isim için ayrı uç yok. Basitleştirme: çocukları öğrenciler tablosundan çekmeyeceğiz.
      // Bu yüzden parent ekranında çocuk seçimi olmadan, sunucu listelerken zaten öğrenci bilgisini döndürüyor.
    }
    async function renderParentAssignments(){
      if(!api.parent) return; const tbody = $('#parentAsTable tbody');
      try{ const list = await api.get('/api/assignments/for-parent/'+api.parent.id);
        const q = ($('#pa-search').value||'').toLowerCase();
        const items = list.filter(a => a.title.toLowerCase().includes(q) || (a.subject||'').toLowerCase().includes(q));
        tbody.innerHTML = items.map(a=> `<tr>
          <td>${a.title} <span class="muted">— ${a.student.name}</span></td>
          <td>${a.subject||'—'}</td>
          <td>${fmtDate(a.due)}</td>
          <td>${a.done?'<span class="badge good">Tamamlandı</span>':'<span class="badge warn">Bekliyor</span>'}</td>
        </tr>`).join('');
      }catch(e){ tbody.innerHTML = '<tr><td colspan="4">Veri alınamadı</td></tr>'; }
    }

    // Tabs + Tools
    function switchTab(el){ $$('.tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); const k = el.dataset.tab; $$('.tabpanel').forEach(p=>p.classList.add('hidden')); document.getElementById('tab-'+k).classList.remove('hidden'); if(k==='parents') fillParentStudentSelect(); if(k==='assignments'){ fillAssignmentTargetsSelect(); if(!document.querySelector('#as-due').value){ document.querySelector('#as-due').value = todayStr(); } renderAssignments(); } }
    function copyText(text){ navigator.clipboard?.writeText(text); toast('Kopyalandı'); }

    // Export/Import
    async function exportData(){ try{ const r = await fetch('/api/export', { headers: api.headers() }); if(!r.ok) throw 0; const blob = await r.blob(); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download='odev-takip-veri.json'; a.click(); URL.revokeObjectURL(url);} catch(e){ toast('Dışa aktarma başarısız. (Öğretmen girişi yapın)'); } }
    document.getElementById('importFile').addEventListener('change', async (e)=>{ const file = e.target.files?.[0]; if(!file) return; const text = await file.text(); try{ const json = JSON.parse(text); await api.post('/api/import', json); toast('İçe aktarıldı.'); }catch(err){ toast('Hatalı JSON veya yetki yok.'); } });

    // Init
    setActiveUser(); checkServer();
  </script>
</body>
</html>